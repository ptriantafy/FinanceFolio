DROP SCHEMA IF EXISTS financefolio;
CREATE SCHEMA financefolio;
USE financefolio;

CREATE TABLE user (
  user_id SMALLINT UNSIGNED NOT NULL AUTO_INCREMENT,
  username VARCHAR(45) NOT NULL,
  register_date DATETIME DEFAULT now(),
  PRIMARY KEY  (user_id),
  CONSTRAINT `unq_user_name` UNIQUE(username)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE member(
  member_id SMALLINT UNSIGNED NOT NULL,
  category TINYINT UNSIGNED NOT NULL,
  income DECIMAL(10,2),
  house_area SMALLINT UNSIGNED,
  residents TINYINT UNSIGNED,
  premium_user BOOLEAN DEFAULT FALSE NOT NULL,
  PRIMARY KEY (member_id),
  CONSTRAINT `fk_user_member_id` FOREIGN KEY (member_id) REFERENCES user (user_id) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE chat(
  chat_id INT UNSIGNED NOT NULL AUTO_INCREMENT,
  PRIMARY KEY(chat_id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE messages(
  message_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  chat_id INT UNSIGNED NOT NULL,
  body VARCHAR(120) NOT NULL,
  receiver_id SMALLINT UNSIGNED NOT NULL,
  sender_id SMALLINT UNSIGNED NOT NULL,
  sent_on DATETIME NOT NULL DEFAULT now(),
  PRIMARY KEY(message_id),
  CONSTRAINT `fk_receiver_chat_id` FOREIGN KEY (receiver_id) REFERENCES member (member_id) ON DELETE RESTRICT ON UPDATE CASCADE,
  CONSTRAINT `fk_chat_message_id` FOREIGN KEY (chat_id) REFERENCES chat(chat_id) ON DELETE RESTRICT ON UPDATE CASCADE,
  CONSTRAINT `fk_sender_chat_id` FOREIGN KEY (sender_id) REFERENCES member (member_id) ON DELETE RESTRICT ON UPDATE CASCADE
)ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE friends(
  member1_id SMALLINT UNSIGNED NOT NULL,
  member2_id SMALLINT UNSIGNED NOT NULL,
  friends_since DATE NOT NULL,
  chat_id INT UNSIGNED NOT NULL,
  sharing_level_to1 TINYINT UNSIGNED NOT NULL DEFAULT 1,
  sharing_level_to2 TINYINT UNSIGNED NOT NULL DEFAULT 1,
  CONSTRAINT `fk_member1_friend_id` FOREIGN KEY (member1_id) REFERENCES member (member_id) ON DELETE RESTRICT ON UPDATE CASCADE,
  CONSTRAINT `fk_chat_friend_id` FOREIGN KEY (chat_id) REFERENCES chat(chat_id) ON DELETE RESTRICT ON UPDATE CASCADE,
  CONSTRAINT `fk_member2_friend_id` FOREIGN KEY (member2_id) REFERENCES member (member_id) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE friend_requests(
  request_id INT UNSIGNED NOT NULL AUTO_INCREMENT,
  sender_id SMALLINT UNSIGNED NOT NULL,
  receiver_id SMALLINT UNSIGNED NOT NULL,
  sender_sharing_level TINYINT UNSIGNED NOT NULL DEFAULT 1,
  sent_on DATETIME DEFAULT now(),
  PRIMARY KEY(request_id),
  CONSTRAINT `fk_receiver_member_id` FOREIGN KEY (receiver_id) REFERENCES member (member_id) ON DELETE RESTRICT ON UPDATE CASCADE,
  CONSTRAINT `fk_sender_member_id` FOREIGN KEY (sender_id) REFERENCES member (member_id) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE points(
 member_id SMALLINT UNSIGNED NOT NULL,
 amount TINYINT NOT NULL DEFAULT 0,
 date DATE NOT NULL,
 CONSTRAINT `fk_member_point_id` FOREIGN KEY (member_id) REFERENCES member (member_id) ON DELETE RESTRICT ON UPDATE CASCADE
)ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
